{"id":"mvp-0kz","title":"Remove '--content' option from set override command","description":"Remove the '--content' option from the set override command in fleetroll CLI. This option should be removed from the command interface and any related code.","status":"open","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-26T15:55:54.165281-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-26T15:55:54.165281-08:00"}
{"id":"mvp-0x9","title":"Standardize exit handling via exceptions","description":"Commands mix paradigms for error handling:\n- cmd_host_set calls sys.exit(1) on failure\n- cmd_host_audit returns normally, relies on caller\n- main() catches exceptions and translates to exit codes\n\nThis inconsistency makes testing harder and behavior unpredictable.\n\nSolution: Commands should raise exceptions (UserError or FleetRollError); main() in cli.py handles all exit code translation. This improves testability and consistency.","status":"open","priority":3,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T18:57:55.31552-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T18:57:55.31552-05:00","dependencies":[{"issue_id":"mvp-0x9","depends_on_id":"mvp-vc5","type":"blocks","created_at":"2026-01-16T18:59:23.120142-05:00","created_by":"Andrew Erickson"},{"issue_id":"mvp-0x9","depends_on_id":"mvp-vsw","type":"blocks","created_at":"2026-01-16T18:59:23.62732-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-27v","title":"Decompose cmd_host_audit_batch function","description":"At 100+ lines, cmd_host_audit_batch (commands/audit.py) handles too many concerns:\n- Threading setup\n- Retry logic\n- Progress bar management\n- Result aggregation\n\nThis makes it hard to test and understand.\n\nSuggested decomposition:\n```python\ndef audit_hosts(hosts, args) -\u003e List[AuditResult]:\n    \"\"\"Pure orchestration - testable without SSH.\"\"\"\n\ndef with_progress(iterable, show: bool):\n    \"\"\"Progress bar wrapper.\"\"\"\n\ndef aggregate_results(results) -\u003e Summary:\n    \"\"\"Result aggregation - separately testable.\"\"\"\n```","status":"open","priority":3,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T18:57:55.527944-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T18:57:55.527944-05:00","dependencies":[{"issue_id":"mvp-27v","depends_on_id":"mvp-vc5","type":"blocks","created_at":"2026-01-16T18:59:23.288041-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-31n","title":"Extend monitor rendering test coverage","description":"The monitor module (fleetroll/commands/monitor.py) is 991 lines but has only 1 test in test_monitor_render.py. This is a critical coverage gap.\n\n## Areas needing tests\n- **Column dropping logic**: compute_columns_and_widths() drops columns when terminal is narrow\n- **Color mapping**: STATUS_COLORS, different states (ok, override, error, stale)\n- **Pagination**: Page up/down, scrolling behavior\n- **Edge cases**: Empty host list, all hosts failed, very long hostnames\n- **Truncation**: Text truncation with ellipsis\n- **Sorting**: Different sort modes (host, status, last_ok)\n- **Filtering**: Host filtering logic\n\n## Why P2\nMonitor is a primary user interface. Bugs here are highly visible. The complex curses logic is error-prone and currently untested. Refactoring (mvp-27v style) will be risky without tests.","status":"open","priority":1,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T14:52:34.770689-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T15:04:12.504942-08:00"}
{"id":"mvp-3cu","title":"Add structured logging for debugging","description":"Beyond the audit file, add optional debug logging for troubleshooting:\n\nimport logging\nlogger = logging.getLogger(__name__)\n\nImplementation:\n- Add --debug / -d flag that sets logging level to DEBUG\n- Add --log-file option for writing logs to file\n- Log key operations: SSH commands (sanitized), retries, timing\n- Use structured format (JSON) for log entries when --json is set\n\nExample:\n  $ fleetroll host-audit myhost --debug\n  DEBUG: Building SSH options: ['-o', 'BatchMode=yes', ...]\n  DEBUG: Executing SSH to myhost (timeout=60s)\n  DEBUG: SSH completed in 1.23s (rc=0)\n  ...\n\nThis helps users diagnose connection issues, timeout problems, etc.","status":"closed","priority":3,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T17:26:56.08001-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T18:03:55.45499-05:00","closed_at":"2026-01-16T18:03:55.45499-05:00","close_reason":"Added --debug/-d flag for debug logging. Logs SSH commands, timing, retries, and connection errors to stderr.","dependencies":[{"issue_id":"mvp-3cu","depends_on_id":"mvp-fgd","type":"blocks","created_at":"2026-01-16T17:27:46.795184-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-5jc","title":"Refactor MonitorDisplay.draw_screen method","description":"MonitorDisplay.draw_screen() in fleetroll/commands/monitor.py is 187 lines (lines 686-872). This violates single-responsibility and makes the code hard to maintain.\n\n## Current structure\nThe method handles:\n- Screen clearing and border drawing\n- Header rendering with status counts\n- Column header rendering\n- Host row rendering with colors\n- Footer/help text rendering\n- Scroll position management\n- Error state display\n\n## Suggested refactoring\nExtract helper methods:\n- draw_header() - Title bar and status summary\n- draw_column_headers() - Column labels\n- draw_host_rows() - Main table content\n- draw_footer() - Help text and key bindings\n- draw_error_state() - Error display\n\n## Why P3\nTechnical debt that doesn't affect functionality. Should be addressed before adding new monitor features (mvp-c29, mvp-hmg). Consider doing after test coverage is improved (reduces refactoring risk).","status":"open","priority":3,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T14:52:35.135656-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T14:52:35.135656-08:00"}
{"id":"mvp-5zx","title":"Prevent duplicate logging handlers","description":"setup_logging adds a new StreamHandler on every call, which can duplicate log lines in tests or repeated CLI invocations in-process. Guard against adding duplicate handlers or reset handlers before adding.","status":"closed","priority":3,"issue_type":"bug","owner":"aerickson@mozilla.com","created_at":"2026-01-20T16:38:48.554758-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-20T22:04:03.559892-08:00","closed_at":"2026-01-20T22:04:03.559892-08:00","close_reason":"Completed"}
{"id":"mvp-6h3","title":"Collect taskcluster worker success rate","description":"Fetch and collect taskcluster worker success rate data. This data will be used by the monitor display feature.","status":"open","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T14:43:57.215282-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T14:43:57.215282-08:00"}
{"id":"mvp-6rl","title":"Add CLI integration tests","description":"Currently only 2 tests in test_commands_audit.py exercise actual command execution. Most tests mock SSH, which misses integration issues.\n\n## Current gaps\n- No end-to-end tests of full CLI flow (argparse → command → output)\n- No tests verifying exit codes for different scenarios\n- No tests of --json output format correctness\n- No tests of error message formatting\n\n## Suggested approach\n1. Use Click's CliRunner for isolated CLI testing\n2. Mock at SSH boundary (not deeper) to test full command logic\n3. Test matrix:\n   - audit: single host, batch, --json, failures\n   - set: with content, from file, syntax error, dry-run\n   - unset: with backup, without backup, missing file\n   - monitor: basic startup (harder to test interactively)\n\n## Why P3\nUnit tests cover most logic. Integration tests are valuable but lower priority than fixing actual gaps. Good to have before major refactoring.","status":"open","priority":3,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T14:52:35.303085-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T14:52:35.303085-08:00"}
{"id":"mvp-7et","title":"Reduce code duplication between single and batch audit","description":"cmd_host_audit_single (line 575) and cmd_host_audit_batch (line 486) share significant logic:\n- Both build SSH options the same way\n- Both call remote_audit_script with same parameters\n- Both process results similarly\n- Both format output (single vs table)\n\nRefactor so batch handles n=1 case, eliminating the separate single-host code path:\n\ndef cmd_host_audit(args):\n    hosts = [args.host] if not is_host_file(args.host) else parse_host_list(...)\n    \n    # Always use batch logic (works for 1 host too)\n    summary = cmd_host_audit_batch(hosts, args)\n    \n    # Format output based on count and args\n    if len(hosts) == 1 and not args.json:\n        format_single_host_output(summary['results'][0], args)\n    else:\n        format_batch_output(summary, args)\n\nThis reduces maintenance burden and ensures consistent behavior.","status":"closed","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T17:26:56.297019-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T17:55:03.783383-05:00","closed_at":"2026-01-16T17:55:03.783383-05:00","close_reason":"Unified single/batch audit paths. Single host now uses batch logic (gains retry support). Created format_single_host_output() for single-host display. Removed cmd_host_audit_single().","dependencies":[{"issue_id":"mvp-7et","depends_on_id":"mvp-fgd","type":"blocks","created_at":"2026-01-16T17:27:46.135067-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-7qf","title":"Use dataclasses for command options instead of argparse.Namespace","description":"argparse.Namespace loses all type information, making IDE support and static analysis ineffective.\n\nCreate typed dataclasses for each command's options:\n\n@dataclass\nclass AuditOptions:\n    host: str\n    override_path: str = DEFAULT_OVERRIDE_PATH\n    role_path: str = DEFAULT_ROLE_PATH\n    no_content: bool = False\n    store_content: bool = False\n    workers: int = 10\n    batch_timeout: int = 600\n    verbose: bool = False\n\n@dataclass  \nclass SetOptions:\n    host: str\n    override_path: str = DEFAULT_OVERRIDE_PATH\n    from_file: Optional[str] = None\n    content: Optional[str] = None\n    mode: str = \"0644\"\n    owner: str = \"root\"\n    group: str = \"root\"\n    ...\n\nBenefits: type checking, IDE autocomplete, self-documenting code.","status":"closed","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T17:26:55.003639-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T17:57:10.824437-05:00","closed_at":"2026-01-16T17:57:10.824437-05:00","close_reason":"Superseded by Click migration. argparse.Namespace replaced with simple Args class. Click provides type validation at CLI level. Typed dataclasses can be added later if strict mypy checking is desired.","dependencies":[{"issue_id":"mvp-7qf","depends_on_id":"mvp-olh","type":"blocks","created_at":"2026-01-16T17:27:46.451255-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-7ud","title":"Investigate audit log truncation threshold","description":"Investigate when the audit log should be truncated to prevent performance issues.\n\n## Analysis\n\nThe audit log is a JSONL file (append-only). Each record is ~500-1000 bytes containing timestamp, actor, action, host, SSH result, and observed state (role, override metadata, SHA256 hash).\n\n### Growth Rate Estimates\n- 1,000 hosts/day → ~0.5-1 MB/day → ~365 MB/year\n- 10,000 hosts/day → ~5-10 MB/day → ~3.6 GB/year\n\n### Performance Thresholds\n- \u003c100 MB: No concern\n- 100 MB - 1 GB: Fine for append-only writes, full scans get slower\n- 1 GB+: Should consider rotation/truncation\n- 10 GB+: Definitely needs attention\n\nJSONL is append-only, so write performance doesn't degrade. Main concerns are disk space and any future features that read the full log.\n\n## Recommendations\n\n1. **Size-based rotation** is simpler than time-based (e.g., rotate at 100 MB or 500 MB)\n2. **Keep it simple** - a `fleetroll audit-log --rotate` command that archives to `audit.log.1.gz`\n3. **MVP approach** - a warning when log exceeds threshold might be enough initially\n\n## Questions to Resolve\n- What's the actual expected usage pattern for this deployment?\n- Do we need queryable history, or is archive-and-forget acceptable?\n- Should rotation be automatic or manual?","status":"open","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T14:31:47.267184-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T14:34:39.838245-08:00"}
{"id":"mvp-83l","title":"Replace die() with proper exception handling","description":"The die() function at line 146 calls sys.exit() directly, which:\n- Makes code hard to test\n- Prevents cleanup in calling code\n- Mixes error reporting with control flow\n\nReplace with a UserError exception class:\n\nclass UserError(FleetRollError):\n    \"\"\"Errors that should be shown to user without traceback.\"\"\"\n    pass\n\n# In command functions:\nraise UserError(\"Refusing to set override without --confirm\")\n\n# In main():\nexcept UserError as e:\n    print(f\"ERROR: {e}\", file=sys.stderr)\n    sys.exit(2)\n\nThis allows tests to catch exceptions and verify error conditions.","status":"closed","priority":1,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T17:26:55.217724-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T17:32:23.72757-05:00","closed_at":"2026-01-16T17:32:23.72757-05:00","close_reason":"Replaced die() with UserError exception class. Exceptions now handled in main() with proper exit codes."}
{"id":"mvp-8vc","title":"Fix embedded shell script boolean in remote_audit_script","description":"Line 207 in remote_audit_script has a fragile pattern:\n\n    if { \"true\" if include_content else \"false\" }; then\n\nThis embeds a Python expression result directly into shell script text, which is confusing and error-prone.\n\nFix by assigning to a variable first:\n    include_cmd = \"true\" if include_content else \"false\"\n    # Then in script:\n    f\"if {include_cmd}; then\"\n\nThis makes the code clearer and less prone to syntax issues.","status":"closed","priority":1,"issue_type":"bug","owner":"aerickson@mozilla.com","created_at":"2026-01-16T17:26:54.795481-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T17:29:53.965214-05:00","closed_at":"2026-01-16T17:29:53.965214-05:00","close_reason":"Extracted inline Python ternary to named variable 'include_content_cmd' for clarity"}
{"id":"mvp-9m0","title":"Add runtime summary for set/unset filelists","description":"When running set/unset with filelists, output a runtime summary at the end (e.g., counts and duration).","status":"closed","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-26T15:46:51.492804-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-26T16:15:42.195593-08:00","closed_at":"2026-01-26T16:15:42.195593-08:00","close_reason":"Completed"}
{"id":"mvp-a7t","title":"Stop writing override content to audit log (store sha only)","description":"Remove --store-content CLI option. Always allow content display in output when fetched, but never persist override contents to audit.jsonl. Audit log should only include override_sha256 and (optionally) stored file path if we keep storing files. Update cli.py (option removal), commands/audit.py and audit.py to stop logging override_contents/override_contents_for_display into JSONL, and adjust tests.","status":"closed","priority":1,"issue_type":"bug","owner":"aerickson@mozilla.com","created_at":"2026-01-20T16:57:15.881342-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-20T22:11:10.656979-08:00","closed_at":"2026-01-20T22:11:10.656979-08:00","close_reason":"Completed"}
{"id":"mvp-agb","title":"Manage vault.yaml + show checksum like override","description":"Add host-set-vault command (single host or host list) with --from-file and --confirm. Store a local copy in ~/.fleetroll/vault_yamls/ like overrides; checksum method/format same as overrides. Push to /root/vault.yaml by default with --path override (e.g., macs). Remote file perms/owner/group should match: -rw-r----- 1 root root. Atomic write like overrides; create a backup (flag-controlled, default on). Display checksum label VLT_SHA after override SHA in audit/monitor; audit shows stored checksum only (no validation).","status":"in_progress","priority":2,"issue_type":"feature","owner":"aerickson@mozilla.com","created_at":"2026-01-26T17:12:28.225107-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-26T18:11:40.287993-08:00"}
{"id":"mvp-aw9","title":"Refactor curses monitor for maintainability","description":"Simplify the host-monitor curses implementation without switching libraries:\n\n1. **Extract draw_screen() to a class** - Currently a 190-line nested function with nonlocal state in monitor.py:704-892. Create a MonitorDisplay class to encapsulate:\n   - Screen state (offset, page_step, max_offset)\n   - Color mappings (sha_colors, role_colors)\n   - The draw_screen() method itself\n\n2. **Separate data layer from rendering** - Move the pipeline out of curses_main():\n   - build_row_values() \n   - compute_columns_and_widths()\n   - render_cell_text()\n   These are already well-structured but embedded in the main function.\n\n3. **Add regression test for table rendering** - Capture expected output for known input to prevent truncation bugs from recurring. Mock curses calls and verify character positions.","status":"closed","priority":3,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T14:17:41.072469-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T14:36:49.924878-08:00","closed_at":"2026-01-21T14:36:49.924878-08:00","close_reason":"Completed"}
{"id":"mvp-azw","title":"Non-zero exit codes for JSON mode on failures","description":"In JSON output mode, commands currently return exit code 0 even when SSH fails. Ensure host-set-override and host-unset-override return non-zero on failure even when --json is used, and ensure host-audit returns non-zero when any host fails in batch mode (and when single-host audit fails). Update tests accordingly.","status":"closed","priority":2,"issue_type":"bug","owner":"aerickson@mozilla.com","created_at":"2026-01-20T16:58:59.503365-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-20T22:20:28.029036-08:00","closed_at":"2026-01-20T22:20:28.029036-08:00","close_reason":"Completed"}
{"id":"mvp-b01","title":"Add trap cleanup to remote shell scripts","description":"The remote scripts use 'set -eu' but intermediate failures leave unclear state. In ssh.py remote_set_script (lines 148-171):\n\n```shell\nsudo -n chmod $m \"$tmp\"   # If this fails...\nsudo -n chown $og \"$tmp\"  # ...this never runs, temp file orphaned\nsudo -n mv -f \"$tmp\" \"$op\" # ...and this never runs\n```\n\nIf chmod succeeds but chown fails, a temp file is left orphaned on the remote host.\n\nSolution: Add explicit trap for cleanup:\n```shell\ntrap 'sudo -n rm -f \"$tmp\" 2\u003e/dev/null' EXIT\n```\n\nApply to all remote script generators in ssh.py.","status":"open","priority":2,"issue_type":"bug","owner":"aerickson@mozilla.com","created_at":"2026-01-16T18:57:55.119574-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T18:57:55.119574-05:00"}
{"id":"mvp-b0e","title":"Add Makefile for common dev commands","description":"Add a Makefile (or justfile) to standardize common development commands.\n\n## Commands to include\n- `make test` - Run pytest\n- `make lint` - Run ruff/mypy checks\n- `make watch` - Run pytest-watcher\n- `make install` - Install dependencies with uv sync\n- `make clean` - Remove __pycache__, .pytest_cache, etc.\n- `make coverage` - Run `uv run pytest --cov --cov-report html --cov-report term-missing`\n\n## Why\nReduces onboarding friction and provides consistent commands across environments. Quick win (~30 min).\n","status":"open","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T15:04:13.388237-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T15:16:57.058511-08:00"}
{"id":"mvp-b65","title":"Add pre-commit hooks (mypy, ruff, bandit)","description":"No static analysis is currently configured for the project. This creates risk of type errors, style drift, and potential security issues going undetected.\n\n## What to add\n- **mypy**: Type checking (codebase already has full type hints)\n- **ruff**: Linting and formatting (replaces flake8, black, isort)\n- **bandit**: Security scanning for common Python vulnerabilities\n\n## Implementation\n1. Add .pre-commit-config.yaml with hooks for mypy, ruff, bandit\n2. Add pyproject.toml sections for mypy and ruff configuration\n3. Fix any issues surfaced by initial run\n4. Document in README how to install pre-commit hooks\n\n## Why P2\nType hints are already present but not validated. Adding mypy will catch real bugs. Ruff will prevent style drift as more contributors join.","status":"open","priority":1,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T14:52:34.597453-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T15:04:12.680845-08:00"}
{"id":"mvp-bns","title":"Document audit log JSON schema","description":"The audit log (JSONL format) has no formal schema documentation. Consumers must read the code to understand the structure.\n\n## Current state\n- Records written by process_audit_result() in fleetroll/audit.py\n- Fields include: ts, actor, action, host, override_path, role_path, ok, ssh_rc, stderr, observed{}\n- observed contains: role_present, role, override_present, override_meta{}, override_sha256, uptime_s\n\n## Deliverables\n1. JSON Schema file (audit-record.schema.json) formally defining the record structure\n2. Example records in documentation showing success/failure cases\n3. Field descriptions explaining semantics (e.g., what does ok=false mean?)\n4. Version field consideration for future schema evolution\n\n## Why P3\nNice to have for external tooling integration. Not blocking current work but improves maintainability and enables third-party consumers.","status":"open","priority":4,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T14:52:34.950414-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T15:04:13.178162-08:00"}
{"id":"mvp-c29","title":"host-monitor: explore bar graph, age sorting, stale filter for LAST_OK","status":"open","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T13:13:10.813797-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T13:13:10.813797-08:00"}
{"id":"mvp-cx5","title":"Address security considerations","description":"Several security-related improvements needed:\n\n1. StrictHostKeyChecking=accept-new (line 171)\n   - Silently accepts new host keys, potential MITM risk\n   - Make configurable via --strict-host-key-checking flag\n   - Add warning when accept-new is used\n\n2. No size limit on content\n   - Large files could cause memory/performance issues\n   - Add --max-size flag (default: 1MB?)\n   - Fail gracefully with clear error if exceeded\n\n3. sudo -n assumption\n   - Code assumes passwordless sudo is configured\n   - Fail gracefully with clear message if sudo prompts for password\n   - Document this requirement in help text\n\n4. Consider adding --no-strict-host-key option for explicit opt-in to less secure mode","status":"closed","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T17:26:55.876066-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T18:01:09.789185-05:00","closed_at":"2026-01-16T18:01:09.789185-05:00","close_reason":"Deferred. Security considerations are minor for MVP scope. Can revisit if needed.","dependencies":[{"issue_id":"mvp-cx5","depends_on_id":"mvp-fgd","type":"blocks","created_at":"2026-01-16T17:27:46.965234-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-dgz","title":"Extract MonitorDisplay into separate modules","description":"The monitor command (commands/monitor.py) is 990 lines handling two distinct concerns that should be separated:\n\n## Current State\n- Single 990-line file mixing data and UI logic\n- Data layer: Log parsing, host state aggregation, filtering\n- UI layer: Curses rendering, input handling, screen layout\n\n## Proposed Structure\n```\nfleetroll/commands/monitor/\n├── __init__.py      # Public exports, cmd_host_monitor entry point\n├── state.py         # HostState, log parsing, aggregation (testable)\n├── display.py       # MonitorDisplay curses class (harder to test)\n└── types.py         # Shared types/dataclasses\n```\n\n## Benefits\n- Data layer becomes easily unit testable without curses mocking\n- Clear separation of concerns\n- Easier to add new display modes (e.g., non-curses JSON streaming)\n- Reduces cognitive load when working on either layer\n\n## Dependencies\nShould be done AFTER:\n- mvp-31n (monitor test coverage) - tests provide safety net for refactor\n- mvp-5jc (refactor draw_screen) - reduces scope of this change","status":"open","priority":3,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T15:06:09.390083-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T15:06:09.390083-08:00","dependencies":[{"issue_id":"mvp-dgz","depends_on_id":"mvp-31n","type":"blocks","created_at":"2026-01-21T15:06:14.460709-08:00","created_by":"Andrew Erickson"},{"issue_id":"mvp-dgz","depends_on_id":"mvp-5jc","type":"blocks","created_at":"2026-01-21T15:06:14.542198-08:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-dov","title":"host-monitor display modes","description":"Add selectable display modes (e.g., all, compact) in host-monitor mode so users can switch views while monitoring.","status":"open","priority":2,"issue_type":"feature","owner":"aerickson@mozilla.com","created_at":"2026-01-26T17:36:30.53934-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-26T17:36:30.53934-08:00"}
{"id":"mvp-esc","title":"Extract generic retry logic","description":"The retry pattern in audit_single_host_with_retry (commands/audit.py:34-118) is useful but tightly coupled to the audit use case.\n\nExtract into a reusable utility:\n```python\ndef with_retry(\n    fn: Callable[[], T],\n    *,\n    max_retries: int = 3,\n    backoff_base: float = 2.0,\n    is_retryable: Callable[[Exception], bool],\n) -\u003e T:\n    \"\"\"Generic retry wrapper with exponential backoff.\"\"\"\n```\n\nThis would allow reuse for set/unset commands if batch mode is added later.","status":"open","priority":4,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T18:57:55.723363-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T15:04:13.007897-08:00","dependencies":[{"issue_id":"mvp-esc","depends_on_id":"mvp-vc5","type":"blocks","created_at":"2026-01-16T18:59:23.454657-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-fgd","title":"Split fleetroll_mvp.py into modules","description":"Refactor the 1000+ line single file into a proper package structure:\n\nfleetroll/\n├── __init__.py\n├── cli.py           # Argument parsing\n├── ssh.py           # run_ssh, remote script generation\n├── audit.py         # Logging, store_override_file\n├── commands/\n│   ├── audit.py\n│   ├── set.py\n│   └── unset.py\n└── utils.py         # utc_now_iso, sha256_hex, etc.\n\nThis improves maintainability, testability, and makes the codebase easier to navigate.","status":"closed","priority":1,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T17:26:54.369429-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T17:43:19.508351-05:00","closed_at":"2026-01-16T17:43:19.508351-05:00","close_reason":"Split fleetroll_mvp.py into modular package: exceptions.py, constants.py, utils.py, ssh.py, audit.py, cli.py, commands/{audit,set,unset}.py","dependencies":[{"issue_id":"mvp-fgd","depends_on_id":"mvp-xkv","type":"blocks","created_at":"2026-01-16T17:27:38.919408-05:00","created_by":"Andrew Erickson"},{"issue_id":"mvp-fgd","depends_on_id":"mvp-83l","type":"blocks","created_at":"2026-01-16T17:27:38.988687-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-fx7","title":"Remote host: cap override backup files","description":"On remote host, ensure there aren't too many override backup files (audit + cleanup/limit as needed).","status":"open","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-26T15:43:55.325655-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-26T15:43:55.325655-08:00"}
{"id":"mvp-g88","title":"Introduce Result dataclasses for command outputs","description":"Command functions currently return untyped dicts/tuples. Introduce typed dataclasses for better IDE support and self-documenting code.\n\n## Current Pattern\n```python\n# Returns dict with implicit schema\nresult = {'host': h, 'ok': True, 'role': r, 'override_sha': sha}\n```\n\n## Proposed Pattern\n```python\n@dataclass(frozen=True)\nclass AuditResult:\n    host: str\n    success: bool\n    role_present: bool\n    override_present: bool\n    override_sha: Optional[str] = None\n    error: Optional[str] = None\n    \n@dataclass(frozen=True)\nclass SetResult:\n    host: str\n    success: bool\n    previous_sha: Optional[str] = None\n    new_sha: Optional[str] = None\n    error: Optional[str] = None\n```\n\n## Result Types to Add\n- AuditResult - for host-audit command\n- SetResult - for host-set-override command\n- UnsetResult - for host-unset-override command\n- HostState - for monitor (may already exist partially)\n\n## Benefits\n- IDE autocomplete and type checking\n- Self-documenting return values\n- Easier refactoring (rename detection)\n- Immutable by default (frozen=True)\n\n## Location\nNew file: `fleetroll/results.py` or inline in each command module","status":"open","priority":3,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T15:06:09.590383-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T15:06:09.590383-08:00"}
{"id":"mvp-hmg","title":"Display taskcluster success rate in host-monitor mode","description":"In host-monitor mode, display the taskcluster success rate for each worker. Requires the success rate data collection to be implemented first.","status":"open","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T14:43:57.406482-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T14:43:57.406482-08:00","dependencies":[{"issue_id":"mvp-hmg","depends_on_id":"mvp-6h3","type":"blocks","created_at":"2026-01-21T14:44:01.104691-08:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-iyp","title":"host-monitor: hide OVR/MTIME, rename SHA","description":"In host-monitor mode, hide OVR and MTIME columns and rename SHA column to OVR_SHA.","status":"open","priority":2,"issue_type":"feature","owner":"aerickson@mozilla.com","created_at":"2026-01-26T17:38:47.876958-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-26T17:38:47.876958-08:00"}
{"id":"mvp-k5e","title":"Confirm before setting/unsetting override when no --confirm flag","description":"When setting or unsetting an override, if the --confirm flag is not provided, prompt the user with a confirmation showing what will happen (e.g., number of hosts and, for set, the override to be applied).","status":"closed","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-26T15:38:52.520499-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-26T16:10:49.05276-08:00","closed_at":"2026-01-26T16:10:49.05276-08:00","close_reason":"Completed"}
{"id":"mvp-l0h","title":"Add structured logging with structlog","description":"Current debug logging uses unstructured string formatting. Structured logging would improve production debugging and observability.\n\n## Current State\n```python\nlogger.debug(f'Auditing host {host}, timeout={timeout}')\n```\n\n## Proposed Pattern\n```python\nimport structlog\nlogger = structlog.get_logger()\n\nlogger.info('audit_started', host=host, timeout=timeout)\nlogger.info('audit_complete', host=host, duration_ms=elapsed, success=True)\nlogger.warning('ssh_retry', host=host, attempt=2, error=str(e))\n```\n\n## Benefits\n- Machine-parseable logs (JSON output option)\n- Consistent field names across log entries\n- Easy integration with log aggregation (ELK, Datadog, etc.)\n- Context binding (add request_id, actor to all logs in a session)\n\n## Implementation\n1. Add structlog to dependencies\n2. Configure processors (JSON for prod, console for dev)\n3. Replace logger.debug/info calls with structured equivalents\n4. Add context binding for actor, session_id\n\n## Priority\nP4 - Nice to have for production deployment, not blocking MVP functionality. Current logging is adequate for development.","status":"open","priority":4,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-21T15:06:09.775593-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T15:06:09.775593-08:00"}
{"id":"mvp-lpb","title":"Add --dry-run mode for set/unset commands","description":"For host-set-override and host-unset-override, add a --dry-run flag that shows what would happen without making changes.\n\nImplementation:\n- Add --dry-run flag to both commands\n- When enabled, audit the current state\n- Show proposed changes (for set: new content hash, permissions; for unset: what would be removed)\n- Skip the actual SSH write/delete operation\n- Still log to audit as action: 'host.set_override.dry_run' or similar\n\nExample output:\n  $ fleetroll host-set-override myhost --from-file new.conf --dry-run --confirm\n  [DRY RUN] Would write to /etc/puppet/ronin_settings on myhost\n  Current: sha256=abc123... (exists)\n  Proposed: sha256=def456... (from new.conf)\n  Mode: 0644, Owner: root:root","status":"closed","priority":2,"issue_type":"feature","owner":"aerickson@mozilla.com","created_at":"2026-01-16T17:26:55.438573-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T18:00:08.755813-05:00","closed_at":"2026-01-16T18:00:08.755813-05:00","close_reason":"Unnecessary. Users can host-audit first to see current state, then use --confirm to execute. Adding --dry-run would duplicate host-audit functionality.","dependencies":[{"issue_id":"mvp-lpb","depends_on_id":"mvp-olh","type":"blocks","created_at":"2026-01-16T17:27:46.625553-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-olh","title":"Migrate from argparse to Click CLI framework","description":"The code currently mixes argparse and click (click is only used for progress bar). Migrate fully to Click for:\n\n- Better subcommand handling\n- Auto-generated help text\n- Consistent CLI patterns\n- Type validation built-in\n- Already a dependency\n\nExample structure:\n@click.group()\n@click.option('--json', is_flag=True)\ndef cli(json):\n    pass\n\n@cli.command()\n@click.argument('host')\ndef host_audit(host):\n    ...","status":"closed","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T17:26:54.57489-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T17:50:16.130243-05:00","closed_at":"2026-01-16T17:50:16.130243-05:00","close_reason":"Migrated from argparse to Click. Added version option, improved help text with show_default, cleaner decorator-based CLI structure.","dependencies":[{"issue_id":"mvp-olh","depends_on_id":"mvp-fgd","type":"blocks","created_at":"2026-01-16T17:27:46.289761-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-r90","title":"Fix concurrent audit log writes (JSONL corruption)","status":"closed","priority":2,"issue_type":"bug","owner":"aerickson@mozilla.com","created_at":"2026-01-20T16:37:11.494389-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-20T16:48:48.726805-08:00","closed_at":"2026-01-20T16:48:48.726805-08:00","close_reason":"Completed"}
{"id":"mvp-sl3","title":"Centralize configuration constants","description":"Hardcoded values are scattered across files:\n- max_retries = 3 (commands/audit.py:47)\n- retry_delay = 2 (commands/audit.py:48)\n- prefix_len = 12 (audit.py:35)\n\nThese should be centralized, either:\n1. Extend constants.py with these values\n2. Create a Config dataclass that can be overridden\n\nThis improves maintainability and makes behavior easier to tune.","status":"open","priority":4,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T18:57:55.926351-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T18:57:55.926351-05:00"}
{"id":"mvp-vc5","title":"Add test suite with pytest","description":"The codebase has zero tests. For a tool that remotely modifies files across a fleet, this is unacceptable risk. Regressions in SSH script generation or result parsing could cause fleet-wide incidents.\n\nTests should cover:\n- Remote script generation (verify shell syntax, quoting)\n- Result parsing (parse_kv_lines, content extraction)\n- CLI argument validation\n- Error handling paths\n\nConsider using pytest fixtures for mocking SSH execution.","status":"closed","priority":1,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T18:57:54.692313-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T19:14:16.840883-05:00","closed_at":"2026-01-16T19:14:16.840883-05:00","close_reason":"Added comprehensive pytest test suite with 140 tests covering utils, SSH scripts, audit logging, commands, CLI, and retry logic"}
{"id":"mvp-vsw","title":"Replace Args bag with typed dataclasses","description":"The Args class (cli.py:28-33) is a dynamic attribute bag that discards type information:\n\n```python\nclass Args:\n    def __init__(self, **kwargs):\n        for key, value in kwargs.items():\n            setattr(self, key, value)\n```\n\nImpact: No IDE completion, runtime AttributeError possible, unclear contracts between CLI and command functions.\n\nSolution: Create typed dataclasses per command:\n- AuditArgs\n- SetArgs  \n- UnsetArgs\n\nUse @dataclass(frozen=True) for immutability.","status":"open","priority":2,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T18:57:54.89867-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-21T15:04:12.834458-08:00","dependencies":[{"issue_id":"mvp-vsw","depends_on_id":"mvp-vc5","type":"blocks","created_at":"2026-01-16T18:59:22.951686-05:00","created_by":"Andrew Erickson"}]}
{"id":"mvp-w5h","title":"Config file support for common CLI settings","description":"Add config file support for common settings (e.g., ssh-timeout, fqdn postfix) so users don't need to specify them on every run.","status":"open","priority":2,"issue_type":"feature","owner":"aerickson@mozilla.com","created_at":"2026-01-26T17:45:08.06593-08:00","created_by":"Andrew Erickson","updated_at":"2026-01-26T17:45:08.06593-08:00"}
{"id":"mvp-xkv","title":"Extract magic strings to module-level constants","description":"Several magic strings are embedded inline throughout the code. Extract to constants at module level for maintainability:\n\n# Constants\nCONTENT_SENTINEL = \"__FLEETROLL_OVERRIDE_CONTENT__\"\nBACKUP_TIME_FORMAT = \"%Y%m%dT%H%M%SZ\"\nDEFAULT_OVERRIDE_PATH = \"/etc/puppet/ronin_settings\"  # already exists\nDEFAULT_ROLE_PATH = \"/etc/puppet_role\"  # already exists\nDEFAULT_AUDIT_SUBDIR = \".fleetroll\"\nDEFAULT_AUDIT_FILENAME = \"audit.jsonl\"\nDEFAULT_OVERRIDES_SUBDIR = \"overrides\"\nSSH_TIMEOUT_EXIT_CODE = 124\n\nThis makes the code more maintainable and easier to modify behavior.","status":"closed","priority":3,"issue_type":"task","owner":"aerickson@mozilla.com","created_at":"2026-01-16T17:26:55.652334-05:00","created_by":"Andrew Erickson","updated_at":"2026-01-16T17:36:09.320868-05:00","closed_at":"2026-01-16T17:36:09.320868-05:00","close_reason":"Extracted 6 constants: CONTENT_SENTINEL, BACKUP_TIME_FORMAT, SSH_TIMEOUT_EXIT_CODE, AUDIT_DIR_NAME, AUDIT_FILE_NAME, OVERRIDES_DIR_NAME"}
